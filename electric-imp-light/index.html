<!DOCTYPE html>
<html>
  <head>
    <title>Create your first connected light using Electric Imp</title>
    <link rel="stylesheet" href="../public/style.css">
    <link rel="stylesheet" href="../public/icons/css/slate.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Italiana&amp;subset=latin">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0">
  </head>
  <body>

    <section id="top">

    <div id="menu">
      <a id="toggle" href="#">
        <i class="icon-menu"></i>
      </a>
      <ul>
        <li><a href="#hardware">Hardware</a></li>
        <li><a href="#software">Software</a></li>
        <li><a href="#hardware-setup">Hardware setup</a></li>
        <li><a href="#lelylan-setup">Lelylan setup</a></li>
        <li><a href="#code">Code</a></li>
        <li><a href="#done">You are done</a></li>
        <li><a href="#code-explained">Code explained</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
        <li><a href="#inspired">Get inspired</a></li>
        <li><a href="#thanks">Thanks</a></li>
      </ul>
    </div>

    <div id="heading">
      <div id="logo">Create your first connected light<br> using Electric Imp</div>
      <div id="tagline">
        <p>
        Control and monitor a connected light from mobile, tablet and desktop using Lelylan<br>
        15 minutes | $44 in hardware | basic level
        </p>
      </div>
      <div class="center">
        <img src="images/header.png" class="bordered"></img>
      <div>
      <div>
        <a href="https://github.com/lelylan/lab-projects/blob/gh-pages/electric-imp-light/index.html" target="_blank">
          <img title="Edit on Github" src="../public/images/github/GitHub-Mark-64px.png" class="github"></img>
        </a>
      </div>
    </div>
    </section>

    <section>
    <div class="content">
      <h1 id="hardware">Hardware</h1>

      <p>
      To complete this tutorial you need the following components.
      <p>

      <table class="table table-stripped table-hover">
        <thead>
          <tr>
            <th>Components</th>
            <th>Buy</th>
            <th>Price</th>
            <th>Quantity</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><a href="https://electricimp.com/product/">Electric Imp</a></td>
            <td><a href="https://www.sparkfun.com/products/11395">Sparkfun</a></td>
            <td>$29.95</td>
            <td>1</td>
          </tr>
          <tr>
            <td>Breakout Board</td>
            <td><a href="https://www.sparkfun.com/products/12886">Sparkfun</a></td>
            <td>$12.95</td>
            <td>1</td>
          </tr>
          <tr>
            <td>Push button</td>
            <td><a href="https://www.sparkfun.com/products/9590" target="_blank">Component packs</a></td>
            <td>$0.35</td>
            <td>1</td>
          </tr>
          <tr>
            <td>Led</td>
            <td><a href="https://www.sparkfun.com/products/9590" target="_blank">Component packs</a></td>
            <td>$0.35</td>
            <td>1</td>
          </tr>
          <tr>
            <td>10K Ohm resistor</td>
            <td><a href="https://www.sparkfun.com/products/10969" target="_blank">Resistor kit</a></td>
            <td>$0.25</td>
            <td>1</td>
          </tr>
        </tbody>
      </table>

    </div>
    </section>

    <section>
    <div class="content">
      <h1 id="software">Software</h1>

      <p>
        In order to connect Electric Imp to the internet follow the official
        <a href="https://electricimp.com/docs/gettingstarted/1-blinkup/">Getting started guide</a>.
        To fully understand this tutorial you need to know the Electric Imp's concepts
        behind <a href="https://electricimp.com/docs/gettingstarted/3-agents/">Agent</a>
        and <a href="https://electricimp.com/docs/gettingstarted/2-helloworld/">Device</a> entities.
      </p>

    </div>
    </section>

    <section>
    <div class="content">
      <h1 id="hardware-setup">Hardware Setup</h1>

      <p>
      This schema represents the led, resistor and pushbutton setup. With this setup
      each time you press the button, the LED is turned on and off.
      </p>

      <img src="images/components.png" class="bordered"></img>

    </div>
    </section>


    <section>
    <div class="content">

      <h1 id="lelylan-setup">Lelylan Setup</h1>

      <p>
      Open <a href="http://lelylan.github.io/devices-dashboard-ng/">Lelylan Dashboard</a>
      and create a new device by following 3 simple steps (if you are new to Lelylan, you can
      <a href="http://people.lelylan.com/users/sign_up">sign up</a> for free).
      </p>

      <h3>1) Set a meaningful name (e.g. bedroom light).</h3>

      <img src="../public/images/shared/step-1.png" class="bordered"></img>

      <h3>2) Choose the device type. For this tutorial choose <em>Basic Light</em>.</h3>

      <p>
      What is a type? A type defines what a device is by defining its properties,
      functions and statuses. For this tutorial you do not need to now more about.
      </p>

      <img src="../public/images/shared/step-2.png" class="bordered"></img>

      <h3>3) Choose <em>Custom URI</em> as connectivity option.</h3>

      <p>
      In order to communicate with the physical device you need to connect Lelylan with the
      Electric Imp agent. Every agent has a unique url that can be found in your Electric Imp Ide.
      </p>

      <img src="images/agent-url.png" class="bordered"></img>

      <p>
      Copy and paste it into the Custom URI field. In this way Lelylan will forward all requests
      coming from the dashboard (or APIs) to the Electric Imp.
      </p>

      <img src="../public/images/shared/step-3-direct.png" class="bordered"></img>

      <h3>4) Get the Device ID and Device Secret.</h3>
      <p>
        Once the device is created, click the settings link (placed under the device name)
        and get the device ID and device secret. You'll need them in the next section.
      </p>
      <img src="../public/images/shared/step-4-a.png" class="bordered" style="margin-bottom:0"></img>
      <img src="../public/images/shared/step-4.png" class="bordered" style="margin-top:0"></img>

    </div>
    </section>


    <section>
    <div class="content">

      <h1 id="code">Code</h1>

      <p>
      Once the (virtual) device is defined on Lelylan you need to make it communicate with
      the Electric Imp. Copy the Electric Imp Agent and Device sketches below and change the
      <code>&lt;DEVICE-ID&gt;</code> and <code>&lt;DEVICE-SECRET&gt;</code> with your device
      credentials.
      </p>

      <script src="https://gist.github.com/andreareginato/2fc35875531f26090d2b.js"></script>

    </div>
    </section>


    <section>
    <div class="content">

      <h1 id="done">You are done</h1>

      <p>
      Access <a href="http://lelylan.github.io/devices-dashboard-ng">Lelylan Dashboard</a>
      and control your connected light from mobile, tablet and desktop. If any problem occours,
      let <a href="http://twitter.com/lelylan">@lelylan</a> know.
      </p>

      <a href="http://lelylan.github.io/devices-dashboard-ng">
        <img src="../public/images/shared/step-5.png" class="bordered"></img>
      </a>

    </div>
    </section>


    <section>
    <div class="content">

      <h1 id="code-explained">Code Explained</h1>

      <p>
      To better understand how the Electric Imp sketch works, follows a brief description of what
      most important sections do.
      </p>

      <h2>Agent Code</h2>

      <h3>Device Settings</h3>

      <p>
        The <code>deviceId</code> and <code>deviceSecret</code> are used to authenticate
        the physical object (Electric Imp) with Lelylan. To get the device credentials open the
        <a href="http://lelylan.github.io/devices-dashboard-ng">Dashboard</a>, select the
        desired device, click on settings and copy the Device ID and the Device Secret.
      </p>

      <script src="https://gist.github.com/andreareginato/37ba8b1e5dde083638a4.js"></script>

      <h3>Sending messages to Lelylan</h3>

      <p>
        To send the physical updates to Lelylan we defined the function
        <code>lelylanSet(properties)</code> which defines the Lelylan endpoint and
        fires the real request.
      </p>

      <script src="https://gist.github.com/andreareginato/cfa0f9efbe439593c3d5.js"></script>

      <p>
        The request function fires the HTTP request to Lelylan. To make it work we first need
        to define the headers by setting the content type (JSON) and the physical secret.
        At this point we can fire the request and let Lelylan know the current light status
        (on or off).
      </p>

      <script src="https://gist.github.com/andreareginato/08a19a8f517aa76c3be3.js"></script>

      <h3>Receiving messages from Lelylan</h3>

      <p>
        To receive the requests from Lelylan the Agent must declare a unique handler for
        incoming requests. In this tutorial we defined the <code>lelylanUpdate</code> function.
      </p>

      <script src="https://gist.github.com/andreareginato/22e2401b9c5d0ee9dcc2.js"></script>

      <p>
        When, interacting with the Dashboard (or API) Lelylan sends a PUT request with the
        properties you want to change in the physical world
        (see <a href="http://dev.lelylan.com/makers#direct-how-to-receive-data">Makers Api</a>).
        The <code>lelylanUpdate</code> function checks for the <code>X-Physical-Secret</code>
        header in order to avoid unauthorized requests and sends an
        <code>update</code> event to the Device Entity with the desired light status in order
        to physically turn the light on or off.
        Once the led status is updated, a confirmation message must to be sent back to
        Lelylan to confirm that the physical changes were successfully applied (if not, the
        device will keep being pending).
      </p>

      <script src="https://gist.github.com/andreareginato/4c613f69b33b9edec220.js"></script>


      <h2>Device Code</h2>

      <h3>Led and Button Pins</h3>

      <p>
        Here we define the pins used to connect the led and the button. If you have followed the
        <a href="#connect-your-first-light-hardware-setup">Fritzing diagram</a> you don't have to change
        anything. If you used different pins, remember to change these values.
      </p>

      <script src="https://gist.github.com/andreareginato/9989f03e5e905bedbdc7.js"></script>


      <h3>Led and Button Logics</h3>

      <p>
        Here we define the variables you need to make the physical button work correctly with the led.
      </p>

      <script src="https://gist.github.com/andreareginato/4311b68859f9f8222810.js"></script>


      <h3>Button's handler</h3>

      <p>
      We use the pushbutton as a switch. Each time you press the button the led is turned on or off.
      To make it work we need to add a debounce, otherwise everytime you press the button a single
      press would be recognized as multiple press.
      </p>

      <p>
      Once the push button is pressed (the led status changes) we publish a message to Lelylan
      to confirm the updated led status.
      </p>

      <script src="https://gist.github.com/andreareginato/5ec459360a35dc1d1cc6.js"></script>

      <h3>Payload</h3>

      <p>
        When communicating with Lelylan we use a fixed JSON structure. For this basic example we
        defined first a Squirrel object which later will be JSON encoded by the Agent.
      </p>

      <p>
      Remember that every message exchanged with Lelylan is made up by a list
      of properties where each of them contains a property ID and a property value.
      For the type "basic light"  we have the status property with ID
      <code>518be5a700045e1521000001</code> accepting the values <code>on</code>
      and <code>off</code>.
      </p>

      <script src="https://gist.github.com/andreareginato/7ba832af1a4273f08abc.js"></script>


    </div>
    </section>

    <section>
    <div class="content">

      <h1 id="troubleshooting">Troubleshooting</h1>

      <p>
      Everything should work just fine. If any problem occours
      <a href="mailto:touch@lelylan.com" target="_blank">mail</a> or
      <a href="http://twitter.com/lelylan" target="_blank">Tweet</a>
      us.
      </p>

    </div>
    </section>

    <section>
    <div class="content">

      <h1 id="inspired">Get inspired</h1>

      <p>
      Did you like this tutorial? You could be interested in the following ones.
      </p>

      <div ng-app="project-app">
        <ly-project ly-project-id="547d9104316135000e000000"></ly-project>
        <ly-project ly-project-id="5457a193386166008d000000"></ly-project>
        <link rel="stylesheet" href="http://lelylan.github.io/lab-directives-ng/styles/main.css">
        <script src="http://lelylan.github.io/lab-directives-ng/scripts/vendor.js"></script>
        <script src="http://lelylan.github.io/lab-directives-ng/scripts/scripts.js"></script>
        <script>angular.module('project-app', ['lelylan-lab.directives.project']);</script>
      </div>

      <br style="clear:both"><br><br>

      <p>
      If you want to learn more check out the
      <a href="http://dev.lelylan.com">Lelylan Dev Center</a> and
      <a href="http://lelylan.github.io/lab-ng/#/">Lelylan Lab</a>.
      </p>

    </div>
    </section>

    <section>
    <div class="content">
      <h1 id="thanks">Thanks</h1>

      <p>
      This article is brought to life from the following people.
      <a href="mailto:touch@lelylan.com" target="_blank">Mail</a> or
      <a href="http://twitter.com/lelylan" target="_blank">Tweet</a>
      us for any idea that can improve the project.
      </p>

      <a href="https://twitter.com/bugduino"><img src="../public/people/bugduino.jpg" class="bordered people"></img></a>

    </div>
    </section>
  </body>
</html>
